var x=Object.defineProperty;var A=(_,e,r)=>e in _?x(_,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):_[e]=r;var E=(_,e,r)=>A(_,typeof e!="symbol"?e+"":e,r);import{_ as z}from"./vendor-pdf-B1igRwBP.js";import{s as c}from"./index-BbSeE-q4.js";const q=_=>{if(!_)return!1;const e=typeof _.message=="string"?_.message:"";return _.code==="PGRST204"||_.code==="42703"||e.includes("eligible_years")},w=class w{async createJobListing(e){var r,o,i,t,p,u,n,g;try{if(console.log("JobsService: Creating new job listing..."),!e.company_name||!e.role_title||!e.domain||!e.location_type||!e.experience_required||!e.qualification||!e.short_description||!e.full_description||!e.application_link)throw new Error("Missing required job listing fields");const{data:{session:d},error:l}=await c.auth.getSession();if(l)throw console.error("JobsService: Session error:",l),new Error("Failed to verify authentication. Please log out and log back in.");if(!d)throw new Error("Authentication required. Please log in.");console.log("JobsService: Checking admin status...");let m=!1;try{const{data:a,error:b}=await c.rpc("debug_admin_status");b?(console.warn("JobsService: debug_admin_status not available, falling back to metadata check:",b.message),m=(((o=(r=d.user)==null?void 0:r.app_metadata)==null?void 0:o.role)||((t=(i=d.user)==null?void 0:i.user_metadata)==null?void 0:t.role))==="admin"):a&&a.is_admin_result&&(console.log("JobsService: Admin check via RPC succeeded."),m=!0)}catch(a){console.warn("JobsService: Error calling debug_admin_status, using fallback:",a),m=(((u=(p=d.user)==null?void 0:p.app_metadata)==null?void 0:u.role)||((g=(n=d.user)==null?void 0:n.user_metadata)==null?void 0:g.role))==="admin"}if(!m)throw new Error("❌ Admin privileges required. You do not have permission to create job listings.");console.log("JobsService: ✅ Admin verification successful. Proceeding with job creation...");const f=(()=>{const a=e.eligible_years;if(!a)return null;if(Array.isArray(a)){const b=a.map(S=>S.trim()).filter(Boolean);return b.length?b.join(", "):null}if(typeof a=="string"){const S=(a.includes(",")||a.includes("|")||a.includes("/")?a.split(/[,|/]/):a.split(/\s+/)).map(J=>J.trim()).filter(Boolean);return S.length?S.join(", "):null}return null})(),s={company_name:e.company_name,company_logo:e.company_logo_url||null,company_website:e.company_website||null,company_description:e.company_description||null,role_title:e.role_title,package_amount:e.package_amount||null,package_currency:e.package_currency||null,package_type:e.package_type||null,domain:e.domain,location_type:e.location_type,location_city:e.location_city||null,experience_required:e.experience_required,qualification:e.qualification,eligible_years:f,short_description:e.short_description,full_description:e.full_description,description:e.full_description,application_link:e.application_link,posted_date:new Date().toISOString(),source_api:"manual_admin",is_active:e.is_active!==void 0?e.is_active:!0,referral_person_name:e.referral_person_name||null,referral_email:e.referral_email||null,referral_code:e.referral_code||null,referral_link:e.referral_link||null,referral_bonus_amount:e.referral_bonus_amount||null,referral_terms:e.referral_terms||null,has_referral:!!(e.referral_person_name||e.referral_email||e.referral_code||e.referral_link),test_requirements:e.test_requirements||null,has_coding_test:e.has_coding_test||!1,has_aptitude_test:e.has_aptitude_test||!1,has_technical_interview:e.has_technical_interview||!1,has_hr_interview:e.has_hr_interview||!1,test_duration_minutes:e.test_duration_minutes||null,ai_polished:!1,ai_polished_at:null,original_description:e.full_description};w.eligibleYearsSupported||delete s.eligible_years,console.log("JobsService: Inserting job data:",s);const v=async a=>c.from("job_listings").insert(a).select().single();let{data:h,error:y}=await v(s);if(y&&q(y)){console.warn("JobsService: eligible_years column not found. Retrying without it."),w.eligibleYearsSupported=!1;const a={...s};delete a.eligible_years,{data:h,error:y}=await v(a)}if(y)throw console.error("JobsService: Error creating job listing:",y),new Error(`Failed to create job listing: ${y.message}

Error Code: ${y.code||"UNKNOWN"}
Hint: ${y.hint||"No additional information"}`);return console.log("JobsService: Job listing created successfully with ID:",h.id),this.polishJobDescriptionInBackground(h.id,h).catch(a=>{console.warn("JobsService: AI polish failed, job will use original description:",a)}),h}catch(d){throw console.error("JobsService: Error in createJobListing:",d),d}}async getJobListingById(e){try{const{data:r,error:o}=await c.from("job_listings").select("*").eq("id",e).eq("is_active",!0).maybeSingle();if(o)throw console.error("Error fetching job listing:",o),new Error(`Failed to fetch job: ${o.message}`);return r}catch(r){throw console.error("Error in getJobListingById:",r),r}}async storeOptimizedResume(e,r,o){try{console.log("JobsService: Storing optimized resume for user:",e,"job:",r);const i=Math.floor(Math.random()*20)+80,t=`https://example.com/resumes/optimized_${e}_${r}.pdf`,p=`https://example.com/resumes/optimized_${e}_${r}.docx`,{data:u,error:n}=await c.from("optimized_resumes").insert({user_id:e,job_listing_id:r,resume_content:o,pdf_url:t,docx_url:p,optimization_score:i}).select("id").single();if(n)throw console.error("Error storing optimized resume:",n),new Error("Failed to store optimized resume");return console.log("JobsService: Optimized resume stored with ID:",u.id),u.id}catch(i){throw console.error("Error in storeOptimizedResume:",i),i}}async getOptimizedResumeById(e){try{const{data:r,error:o}=await c.from("optimized_resumes").select("*").eq("id",e).maybeSingle();return o?(console.error("Error fetching optimized resume:",o),null):r}catch(r){return console.error("Error in getOptimizedResumeById:",r),null}}async getJobListings(e={},r=20,o=0){try{console.log("JobsService: Fetching job listings from database with filters:",e);let i=c.from("job_listings").select("*",{count:"exact"});if(e.domain&&(i=i.eq("domain",e.domain)),e.location_type&&(i=i.eq("location_type",e.location_type)),e.experience_required&&(i=i.eq("experience_required",e.experience_required)),e.eligible_year&&w.eligibleYearsSupported&&(i=i.ilike("eligible_years",`%${e.eligible_year}%`)),e.package_min&&(i=i.gte("package_amount",e.package_min)),e.package_max&&(i=i.lte("package_amount",e.package_max)),e.search){const s=e.search.toLowerCase();i=i.or(`role_title.ilike.%${s}%,company_name.ilike.%${s}%,domain.ilike.%${s}%`)}if(e.sort_by){const s=e.sort_order==="asc";i=i.order(e.sort_by,{ascending:s})}else i=i.order("posted_date",{ascending:!1});i=i.range(o,o+r-1);const{data:t,error:p,count:u}=await i;if(p)throw console.error("JobsService: Database error:",p),new Error(`Failed to fetch jobs: ${p.message}`);console.log(`JobsService: Fetched ${(t==null?void 0:t.length)||0} jobs from database (total: ${u})`);const{data:n,error:g}=await c.from("job_listings").select("company_name").eq("is_active",!0),d=g?0:new Set((n==null?void 0:n.map(s=>s.company_name))||[]).size,l=u||0,m=o+r<l,f=Math.ceil(l/r);return{jobs:t||[],total:l,hasMore:m,totalPages:f,totalCompanies:d}}catch(i){throw console.error("JobsService: Error fetching job listings:",i),i}}async getAllJobs(){try{console.log("JobsService: Fetching all jobs for AI matching...");const{data:e,error:r}=await c.from("job_listings").select("*").eq("is_active",!0).order("posted_date",{ascending:!1}).limit(1e3);if(r)throw console.error("JobsService: Database error fetching all jobs:",r),new Error(`Failed to fetch jobs: ${r.message}`);return console.log(`JobsService: Fetched ${(e==null?void 0:e.length)||0} jobs for AI matching`),e||[]}catch(e){throw console.error("JobsService: Error fetching all jobs:",e),e}}async optimizeResumeForJob(e,r){try{const{data:{session:o}}=await c.auth.getSession();if(!o)throw new Error("Authentication required");const i=await fetch("https://rixmudvtbfkjpwjoefon.supabase.co/functions/v1/optimize-resume-for-job",{method:"POST",headers:{Authorization:`Bearer ${o.access_token}`,"Content-Type":"application/json"},body:JSON.stringify({jobId:e,userResumeText:r})});if(!i.ok){const p=await i.json();throw new Error(p.error||"Failed to optimize resume")}const t=await i.json();if(!t.success)throw new Error(t.error||"Resume optimization failed");return{id:t.resumeId,user_id:o.user.id,job_listing_id:e,resume_content:t.resumeContent,pdf_url:t.pdfUrl,docx_url:t.docxUrl,optimization_score:t.optimizationScore,created_at:new Date().toISOString()}}catch(o){throw console.error("Error optimizing resume for job:",o),o}}async logManualApplication(e,r,o){try{const{data:{session:i}}=await c.auth.getSession();if(!i)throw new Error("Authentication required");const{error:t}=await c.from("manual_apply_logs").insert({user_id:i.user.id,job_listing_id:e,optimized_resume_id:r,application_date:new Date().toISOString(),status:"submitted",redirect_url:o});if(t)throw console.error("Error logging manual application:",t),new Error("Failed to log manual application")}catch(i){throw console.error("Error in logManualApplication:",i),i}}async autoApplyForJob(e,r){try{const{data:{session:o}}=await c.auth.getSession();if(!o)throw new Error("Authentication required");const t=await(await fetch("https://rixmudvtbfkjpwjoefon.supabase.co/functions/v1/auto-apply",{method:"POST",headers:{Authorization:`Bearer ${o.access_token}`,"Content-Type":"application/json"},body:JSON.stringify({jobId:e,optimizedResumeId:r})})).json();return{success:t.success,message:t.message,applicationId:t.applicationId,status:t.status,screenshotUrl:t.screenshotUrl,resumeUrl:t.resumeUrl,fallbackUrl:t.fallbackUrl,error:t.error}}catch(o){throw console.error("Error in auto apply:",o),new Error("Auto-apply failed")}}async getApplicationHistory(e={}){try{const{data:{session:r}}=await c.auth.getSession();if(!r)throw new Error("Authentication required");const o=new URLSearchParams({...e.status&&{status:e.status},...e.method&&{method:e.method}}),i=await fetch(`https://rixmudvtbfkjpwjoefon.supabase.co/functions/v1/get-application-history?${o}`,{method:"GET",headers:{Authorization:`Bearer ${r.access_token}`,"Content-Type":"application/json"}});if(!i.ok)throw new Error(`Failed to fetch application history: ${i.statusText}`);return await i.json()}catch(r){throw console.error("Error fetching application history:",r),new Error("Failed to fetch application history")}}async polishJobDescriptionInBackground(e,r){try{const{deepseekService:o}=await z(async()=>{const{deepseekService:u}=await import("./deepseekService-BJOuo5BV.js");return{deepseekService:u}},[]);if(!o.isConfigured()){console.log("JobsService: DeepSeek not configured, skipping AI polish");return}console.log("JobsService: Starting AI polish for job:",e);const i=await o.polishJobDescription({companyName:r.company_name,roleTitle:r.role_title,domain:r.domain,description:r.full_description,qualification:r.qualification,experienceRequired:r.experience_required});let t=r.company_description;t||(t=await o.generateCompanyDescription({companyName:r.company_name,roleTitle:r.role_title,domain:r.domain,jobDescription:r.full_description,qualification:r.qualification,experienceRequired:r.experience_required}));const{error:p}=await c.from("job_listings").update({full_description:i,description:i,company_description:t,ai_polished:!0,ai_polished_at:new Date().toISOString()}).eq("id",e);p?console.error("JobsService: Failed to update job with AI polish:",p):console.log("JobsService: AI polish completed successfully for job:",e)}catch(o){console.error("JobsService: Error in AI polish background task:",o)}}async getJobsByCompany(e){var r,o,i,t,p;try{const u=e.replace(/-/g," "),{data:n,error:g,count:d}=await c.from("job_listings").select("*",{count:"exact"}).ilike("company_name",`%${u}%`).eq("is_active",!0).order("posted_date",{ascending:!1});if(g)throw new Error(`Failed to fetch company jobs: ${g.message}`);const l=((r=n==null?void 0:n[0])==null?void 0:r.company_name)||u,m=((o=n==null?void 0:n[0])==null?void 0:o.company_logo_url)||((i=n==null?void 0:n[0])==null?void 0:i.company_logo)||null,f=((t=n==null?void 0:n[0])==null?void 0:t.company_website)||null,s=((p=n==null?void 0:n[0])==null?void 0:p.company_description)||null;return{jobs:n||[],companyName:l,companyLogo:m,companyWebsite:f,companyDescription:s,total:d||0}}catch(u){throw console.error("Error fetching company jobs:",u),u}}async getFilterOptions(){try{const{data:e}=await c.from("job_listings").select("domain").eq("is_active",!0),{data:r}=await c.from("job_listings").select("location_type").eq("is_active",!0),{data:o}=await c.from("job_listings").select("experience_required").eq("is_active",!0),{data:i}=await c.from("job_listings").select("package_amount").eq("is_active",!0).not("package_amount","is",null);let t=[];if(w.eligibleYearsSupported){const{data:l,error:m}=await c.from("job_listings").select("eligible_years").eq("is_active",!0);if(m)q(m)?w.eligibleYearsSupported=!1:console.error("Error fetching eligible years:",m);else if(l){const f=new Set;l.forEach(s=>{if(!(s!=null&&s.eligible_years))return;(s.eligible_years.includes(",")||s.eligible_years.includes("|")||s.eligible_years.includes("/")?s.eligible_years.split(/[,|/]/):s.eligible_years.split(/\s+/)).map(h=>h.trim()).filter(Boolean).forEach(h=>f.add(h))}),t=Array.from(f).sort()}}const p=[...new Set((e==null?void 0:e.map(l=>l.domain))||[])],u=[...new Set((r==null?void 0:r.map(l=>l.location_type))||[])],n=[...new Set((o==null?void 0:o.map(l=>l.experience_required))||[])],g=(i==null?void 0:i.map(l=>l.package_amount).filter(Boolean))||[],d={min:Math.min(...g,0),max:Math.max(...g,1e6)};return{domains:p,locationTypes:u,experienceLevels:n,eligibleYears:t,packageRanges:d}}catch(e){return console.error("Error getting filter options:",e),{domains:["SDE","Data Science","Product","Marketing","Analytics"],locationTypes:["Remote","Onsite","Hybrid"],experienceLevels:["0-1 years","0-2 years","1-2 years","1-3 years","2-4 years","3-5 years"],eligibleYears:["2022","2023","2024","2025","2026"],packageRanges:{min:0,max:1e6}}}}};E(w,"eligibleYearsSupported",!0);let k=w;const I=new k;export{I as j};
