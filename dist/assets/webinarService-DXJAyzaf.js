import{s as r}from"./index-BbSeE-q4.js";class l{async getAllWebinars(e){let t=r.from("webinars").select("*").order("scheduled_at",{ascending:!0});e!=null&&e.status&&(t=t.eq("status",e.status)),(e==null?void 0:e.is_featured)!==void 0&&(t=t.eq("is_featured",e.is_featured)),e!=null&&e.search&&(t=t.or(`title.ilike.%${e.search}%,description.ilike.%${e.search}%`)),e!=null&&e.from_date&&(t=t.gte("scheduled_at",e.from_date)),e!=null&&e.to_date&&(t=t.lte("scheduled_at",e.to_date));const{data:a,error:i}=await t;if(i)throw new Error("Failed to fetch webinars");return a||[]}async getWebinarBySlug(e){var i;const{data:t,error:a}=await r.from("webinars").select("*").eq("slug",e).maybeSingle();if(a)throw new Error("Failed to fetch webinar");if(!t)return null;if(((i=t.speaker_ids)==null?void 0:i.length)>0){const{data:n}=await r.from("webinar_speakers").select("*").in("id",t.speaker_ids);return{...t,speakers:n||[]}}return t}async getWebinarById(e){var i;const{data:t,error:a}=await r.from("webinars").select("*").eq("id",e).maybeSingle();if(a)throw new Error("Failed to fetch webinar");if(!t)return null;if(((i=t.speaker_ids)==null?void 0:i.length)>0){const{data:n}=await r.from("webinar_speakers").select("*").in("id",t.speaker_ids);return{...t,speakers:n||[]}}return t}async getUpcomingWebinars(e){let t=r.from("webinars").select("*").eq("status","upcoming").gte("scheduled_at",new Date().toISOString()).order("scheduled_at",{ascending:!0});e&&(t=t.limit(e));const{data:a,error:i}=await t;if(i)throw new Error("Failed to fetch upcoming webinars");return a||[]}async getFeaturedWebinars(){const{data:e,error:t}=await r.from("webinars").select("*").eq("is_featured",!0).eq("status","upcoming").gte("scheduled_at",new Date().toISOString()).order("scheduled_at",{ascending:!0}).limit(3);if(t)throw new Error("Failed to fetch featured webinars");return e||[]}async checkWebinarCapacity(e){const{data:t,error:a}=await r.rpc("check_webinar_capacity",{p_webinar_id:e});return a?!1:t===!0}async createRegistration(e,t,a){const{data:i,error:n}=await r.from("webinar_registrations").insert({webinar_id:e,user_id:t,...a,registration_status:"pending",payment_status:"pending"}).select().single();if(n)throw new Error("Failed to create registration");return i}async updateRegistrationPayment(e,t,a){const i={payment_transaction_id:t,payment_status:a,updated_at:new Date().toISOString()};a==="completed"&&(i.registration_status="confirmed");const{error:n}=await r.from("webinar_registrations").update(i).eq("id",e);if(n)throw new Error("Failed to update registration payment")}async getUserRegistrations(e){const{data:t,error:a}=await r.from("webinar_registrations").select("*, webinar:webinars(*)").eq("user_id",e).order("created_at",{ascending:!1});if(a)throw new Error("Failed to fetch registrations");return t||[]}async getRegistrationById(e){const{data:t,error:a}=await r.from("webinar_registrations").select("*, webinar:webinars(*)").eq("id",e).maybeSingle();if(a)throw new Error("Failed to fetch registration");return t}async checkUserRegistration(e,t){const{data:a,error:i}=await r.from("webinar_registrations").select("*").eq("user_id",e).eq("webinar_id",t).maybeSingle();return i?null:a}async getAllSpeakers(){const{data:e,error:t}=await r.from("webinar_speakers").select("*").order("created_at",{ascending:!1});if(t)throw new Error("Failed to fetch speakers");return e||[]}async createSpeaker(e){const{data:t,error:a}=await r.from("webinar_speakers").insert(e).select().single();if(a)throw new Error("Failed to create speaker");return t}async updateSpeaker(e,t){const{data:a,error:i}=await r.from("webinar_speakers").update({...t,updated_at:new Date().toISOString()}).eq("id",e).select().single();if(i)throw new Error("Failed to update speaker");return a}async deleteSpeaker(e){const{error:t}=await r.from("webinar_speakers").delete().eq("id",e);if(t)throw new Error("Failed to delete speaker")}async getTestimonials(e=!1){let t=r.from("webinar_testimonials").select("*").order("created_at",{ascending:!1});e&&(t=t.eq("is_featured",!0));const{data:a,error:i}=await t;if(i)throw new Error("Failed to fetch testimonials");return a||[]}async createTestimonial(e){const{data:t,error:a}=await r.from("webinar_testimonials").insert(e).select().single();if(a)throw new Error("Failed to create testimonial");return t}async updateTestimonial(e,t){const{data:a,error:i}=await r.from("webinar_testimonials").update(t).eq("id",e).select().single();if(i)throw new Error("Failed to update testimonial");return a}async deleteTestimonial(e){const{error:t}=await r.from("webinar_testimonials").delete().eq("id",e);if(t)throw new Error("Failed to delete testimonial")}async logEmail(e){const{error:t}=await r.from("webinar_email_logs").insert(e);t&&console.error("Error logging email:",t)}async getWebinarStats(){const{data:e}=await r.from("webinars").select("id, status, current_attendees, max_attendees"),{data:t}=await r.from("webinar_registrations").select("payment_status").eq("payment_status","completed"),a=(e==null?void 0:e.length)||0,i=(e==null?void 0:e.filter(o=>o.status==="upcoming").length)||0,n=(t==null?void 0:t.length)||0,d=(e==null?void 0:e.filter(o=>o.status==="completed"))||[],s=d.reduce((o,c)=>o+(c.current_attendees||0),0),w=d.reduce((o,c)=>o+(c.max_attendees||0),0),u=w?s/w*100:0;return{total_webinars:a,upcoming_webinars:i,total_registrations:n,total_revenue:0,average_attendance:Math.round(u)}}async getWebinarUpdates(e,t){const{data:a,error:i}=await r.from("webinar_updates").select("*").eq("webinar_id",e).eq("is_published",!0).order("created_at",{ascending:!1});if(i)throw new Error("Failed to fetch webinar updates");if(!a||!t)return a||[];const{data:n}=await r.from("webinar_update_views").select("update_id").eq("user_id",t).in("update_id",a.map(s=>s.id)),d=new Set((n||[]).map(s=>s.update_id));return a.map(s=>({...s,is_viewed:d.has(s.id)}))}async getUnreadUpdatesCount(e,t){const{data:a,error:i}=await r.rpc("get_unread_webinar_updates_count",{p_user_id:e,p_webinar_id:t});return i?0:a||0}async markUpdateAsViewed(e,t){const{error:a}=await r.from("webinar_update_views").upsert({update_id:e,user_id:t},{onConflict:"update_id,user_id"});a&&console.error("Error marking update as viewed:",a)}async markAllUpdatesAsViewed(e,t){const{data:a}=await r.from("webinar_updates").select("id").eq("webinar_id",e).eq("is_published",!0);if(!(a!=null&&a.length))return;const i=a.map(d=>({update_id:d.id,user_id:t})),{error:n}=await r.from("webinar_update_views").upsert(i,{onConflict:"update_id,user_id"});n&&console.error("Error marking all updates as viewed:",n)}async createWebinarUpdate(e){const{data:t,error:a}=await r.from("webinar_updates").insert(e).select().single();if(a)throw new Error("Failed to create webinar update");return t}async updateWebinarUpdate(e){const{id:t,...a}=e,{data:i,error:n}=await r.from("webinar_updates").update(a).eq("id",t).select().single();if(n)throw new Error("Failed to update webinar update");return i}async deleteWebinarUpdate(e){const{error:t}=await r.from("webinar_updates").delete().eq("id",e);if(t)throw new Error("Failed to delete webinar update")}async getAllWebinarUpdates(e){const{data:t,error:a}=await r.from("webinar_updates").select("*").eq("webinar_id",e).order("created_at",{ascending:!1});if(a)throw new Error("Failed to fetch all webinar updates");return t||[]}}const g=new l;export{g as w};
