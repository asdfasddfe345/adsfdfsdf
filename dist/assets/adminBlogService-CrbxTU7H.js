import{s as a}from"./index-BbSeE-q4.js";const p={async fetchAllPosts(r=1,t=20,o){try{let e=a.from("blog_posts").select("*",{count:"exact"}).order("created_at",{ascending:!1});if(o!=null&&o.status&&(e=e.eq("status",o.status)),o!=null&&o.search&&(e=e.or(`title.ilike.%${o.search}%,body_content.ilike.%${o.search}%`)),o!=null&&o.category_id){const{data:c}=await a.from("blog_post_categories").select("blog_post_id").eq("blog_category_id",o.category_id);if(c&&c.length>0)e=e.in("id",c.map(n=>n.blog_post_id));else return{posts:[],total:0,page:r,pageSize:t,totalPages:0}}const s=(r-1)*t,i=s+t-1;e=e.range(s,i);const{data:g,error:l,count:_}=await e;if(l)throw l;return{posts:await Promise.all((g||[]).map(async c=>{const n=await this.getPostCategories(c.id),d=await this.getPostTags(c.id);return{...c,categories:n,tags:d}})),total:_||0,page:r,pageSize:t,totalPages:Math.ceil((_||0)/t)}}catch(e){throw console.error("Error fetching all posts:",e),e}},async fetchPostById(r){try{const{data:t,error:o}=await a.from("blog_posts").select("*").eq("id",r).maybeSingle();if(o)throw o;if(!t)return null;const e=await this.getPostCategories(t.id),s=await this.getPostTags(t.id);return{...t,categories:e,tags:s}}catch(t){throw console.error("Error fetching post by id:",t),t}},async createBlogPost(r){var t,o;try{const{data:e}=await a.auth.getUser(),s={title:r.title,slug:r.slug,excerpt:r.excerpt||null,body_content:r.body_content,featured_image_url:r.featured_image_url||null,author_id:((t=e==null?void 0:e.user)==null?void 0:t.id)||null,author_name:r.author_name||((o=e==null?void 0:e.user)==null?void 0:o.email)||"Admin",status:r.status,published_at:r.status==="published"&&!r.published_at?new Date().toISOString():r.published_at||null,meta_title:r.meta_title||r.title,meta_description:r.meta_description||r.excerpt||null},{data:i,error:g}=await a.from("blog_posts").insert(s).select().single();if(g)throw g;return r.category_ids&&r.category_ids.length>0&&await this.updatePostCategories(i.id,r.category_ids),r.tag_ids&&r.tag_ids.length>0&&await this.updatePostTags(i.id,r.tag_ids),i}catch(e){throw console.error("Error creating blog post:",e),e}},async updateBlogPost(r){try{const t={...r};if(delete t.id,delete t.category_ids,delete t.tag_ids,r.status==="published"&&!r.published_at){const{data:s}=await a.from("blog_posts").select("published_at").eq("id",r.id).single();s!=null&&s.published_at||(t.published_at=new Date().toISOString())}const{data:o,error:e}=await a.from("blog_posts").update(t).eq("id",r.id).select().single();if(e)throw e;return r.category_ids!==void 0&&await this.updatePostCategories(r.id,r.category_ids),r.tag_ids!==void 0&&await this.updatePostTags(r.id,r.tag_ids),o}catch(t){throw console.error("Error updating blog post:",t),t}},async deleteBlogPost(r){try{const{error:t}=await a.from("blog_posts").delete().eq("id",r);if(t)throw t}catch(t){throw console.error("Error deleting blog post:",t),t}},async updatePostCategories(r,t){try{if(await a.from("blog_post_categories").delete().eq("blog_post_id",r),t.length>0){const o=t.map(s=>({blog_post_id:r,blog_category_id:s})),{error:e}=await a.from("blog_post_categories").insert(o);if(e)throw e}}catch(o){throw console.error("Error updating post categories:",o),o}},async updatePostTags(r,t){try{if(await a.from("blog_post_tags").delete().eq("blog_post_id",r),t.length>0){const o=t.map(s=>({blog_post_id:r,blog_tag_id:s})),{error:e}=await a.from("blog_post_tags").insert(o);if(e)throw e}}catch(o){throw console.error("Error updating post tags:",o),o}},async getPostCategories(r){try{const{data:t,error:o}=await a.from("blog_post_categories").select(`
          blog_category_id,
          blog_categories (*)
        `).eq("blog_post_id",r);if(o)throw o;return(t||[]).map(e=>e.blog_categories).filter(Boolean)}catch(t){return console.error("Error fetching post categories:",t),[]}},async getPostTags(r){try{const{data:t,error:o}=await a.from("blog_post_tags").select(`
          blog_tag_id,
          blog_tags (*)
        `).eq("blog_post_id",r);if(o)throw o;return(t||[]).map(e=>e.blog_tags).filter(Boolean)}catch(t){return console.error("Error fetching post tags:",t),[]}},async createCategory(r,t){try{const o=this.generateSlug(r),{data:e,error:s}=await a.from("blog_categories").insert({name:r,slug:o,description:t||null}).select().single();if(s)throw s;return e}catch(o){throw console.error("Error creating category:",o),o}},async updateCategory(r,t,o){try{const e=this.generateSlug(t),{data:s,error:i}=await a.from("blog_categories").update({name:t,slug:e,description:o||null}).eq("id",r).select().single();if(i)throw i;return s}catch(e){throw console.error("Error updating category:",e),e}},async deleteCategory(r){try{const{error:t}=await a.from("blog_categories").delete().eq("id",r);if(t)throw t}catch(t){throw console.error("Error deleting category:",t),t}},async createTag(r){try{const t=this.generateSlug(r),{data:o,error:e}=await a.from("blog_tags").insert({name:r,slug:t}).select().single();if(e)throw e;return o}catch(t){throw console.error("Error creating tag:",t),t}},async updateTag(r,t){try{const o=this.generateSlug(t),{data:e,error:s}=await a.from("blog_tags").update({name:t,slug:o}).eq("id",r).select().single();if(s)throw s;return e}catch(o){throw console.error("Error updating tag:",o),o}},async deleteTag(r){try{const{error:t}=await a.from("blog_tags").delete().eq("id",r);if(t)throw t}catch(t){throw console.error("Error deleting tag:",t),t}},async fetchAllCategories(){try{const{data:r,error:t}=await a.from("blog_categories").select("*").order("name");if(t)throw t;return r||[]}catch(r){return console.error("Error fetching categories:",r),[]}},async fetchAllTags(){try{const{data:r,error:t}=await a.from("blog_tags").select("*").order("name");if(t)throw t;return r||[]}catch(r){return console.error("Error fetching tags:",r),[]}},generateSlug(r){return r.toLowerCase().trim().replace(/[^\w\s-]/g,"").replace(/[\s_-]+/g,"-").replace(/^-+|-+$/g,"")}};export{p as a};
