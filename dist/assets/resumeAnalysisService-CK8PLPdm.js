var x=Object.defineProperty;var D=(o,e,r)=>e in o?x(o,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):o[e]=r;var y=(o,e,r)=>D(o,typeof e!="symbol"?e+"":e,r);import{s as i}from"./index-BbSeE-q4.js";import{p}from"./vendor-pdf-B1igRwBP.js";import{l as k}from"./index-4HxsnF8w.js";import{g as S}from"./geminiServiceWrapper-tvm4MzT7.js";p.GlobalWorkerOptions.workerSrc=`//cdnjs.cloudflare.com/ajax/libs/pdf.js/${p.version}/pdf.worker.min.js`;class v{constructor(){y(this,"commonSkills",["React","Angular","Vue","JavaScript","TypeScript","Node.js","Python","Java","C++","C#","PHP","Ruby","Go","Rust","Swift","Kotlin","HTML","CSS","Sass","Tailwind","Bootstrap","SQL","MongoDB","PostgreSQL","MySQL","Redis","Docker","Kubernetes","AWS","Azure","GCP","Git","CI/CD","Jenkins","GraphQL","REST API","Machine Learning","Deep Learning","TensorFlow","PyTorch","Data Science","AI","Spring Boot","Django","Flask","Express","Next.js","Nest.js","React Native","Flutter","Android","iOS","Figma","Adobe XD","Photoshop","Illustrator","UI/UX","Agile","Scrum","Jira"])}async parseResume(e){try{const r=e.type;let t="";if(r==="application/pdf")t=await this.parsePDF(e);else if(r==="application/vnd.openxmlformats-officedocument.wordprocessingml.document"||r==="application/msword")t=await this.parseDOCX(e);else if(r==="text/plain")t=await this.parseText(e);else throw new Error("Unsupported file type. Please upload PDF, DOCX, or TXT file.");if(!t||t.trim().length===0)throw new Error("Could not extract text from the file. Please try a different file.");const a=this.extractSkills(t),s=t.split(/\s+/).length;return{text:t,skills:a,wordCount:s,hasError:!1}}catch(r){return console.error("Error parsing resume:",r),{text:"",skills:[],wordCount:0,hasError:!0,errorMessage:r.message||"Failed to parse resume"}}}async parsePDF(e){try{const r=await e.arrayBuffer(),t=await p.getDocument({data:r}).promise;let a="";for(let s=1;s<=t.numPages;s++){const m=(await(await t.getPage(s)).getTextContent()).items.map(l=>l.str).join(" ");a+=m+`
`}return a.trim()}catch(r){throw console.error("PDF parsing error:",r),new Error("Failed to parse PDF file")}}async parseDOCX(e){try{const r=await e.arrayBuffer();return(await k.extractRawText({arrayBuffer:r})).value.trim()}catch(r){throw console.error("DOCX parsing error:",r),new Error("Failed to parse DOCX file")}}async parseText(e){try{return await e.text()}catch(r){throw console.error("Text parsing error:",r),new Error("Failed to parse text file")}}extractSkills(e){const r=e.toLowerCase(),t=new Set;return this.commonSkills.forEach(a=>{const s=a.toLowerCase();r.includes(s)&&t.add(a)}),Array.from(t)}validateFile(e){const t=["application/pdf","application/vnd.openxmlformats-officedocument.wordprocessingml.document","application/msword","text/plain"];return e.size>5242880?{valid:!1,error:"File size must be less than 5MB"}:t.includes(e.type)?{valid:!0}:{valid:!1,error:"Only PDF, DOCX, and TXT files are supported"}}getFileIcon(e){return e==="application/pdf"?"ðŸ“„":e.includes("word")?"ðŸ“":e==="text/plain"?"ðŸ“ƒ":"ðŸ“Ž"}}const h=new v;class F{async uploadAndAnalyzeResume(e,r){const t=h.validateFile(e);if(!t.valid)throw new Error(t.error||"Invalid file");const s=(u=>{const d=u.lastIndexOf("."),_=(d>0?u.slice(0,d):u).normalize("NFKD").replace(/[\u0300-\u036f]/g,"").replace(/[^A-Za-z0-9._-]+/g,"-").replace(/-{2,}/g,"-").replace(/^[-_.]+|[-_.]+$/g,""),w=(d>0?u.slice(d+1):"").replace(/[^A-Za-z0-9]/g,"").slice(0,10);return((w?`${_}.${w}`:_)||`resume_${Date.now()}.pdf`).slice(0,120)})(e.name),n=`${r}/${Date.now()}_${s}`,{error:c}=await i.storage.from("user-resumes").upload(n,e,{contentType:e.type,upsert:!1});if(c)throw new Error(`Failed to upload resume: ${c.message}`);const{data:m}=i.storage.from("user-resumes").getPublicUrl(n),l=await h.parseResume(e);if(l.hasError)throw new Error(l.errorMessage||"Failed to parse resume");const{data:f,error:g}=await i.from("user_resumes").insert({user_id:r,file_url:m.publicUrl,file_name:e.name,file_type:e.type,file_size:e.size,parsed_text:l.text,parsed_data:{},skills_detected:l.skills,analysis_completed:!1,is_primary:!1}).select().single();if(g)throw new Error(`Failed to save resume: ${g.message}`);return this.analyzeResumeInBackground(f.id,l.text,r),f}async analyzeResumeInBackground(e,r,t){try{const a=await this.performDeepAnalysis(r);await i.from("user_resumes").update({parsed_data:a.parsed_data,skills_detected:a.skills_detected,experience_level:a.experience_level,years_of_experience:a.years_of_experience,domains:a.domains,analysis_metadata:a.analysis_metadata,analysis_completed:!0}).eq("id",e)}catch(a){console.error("Background analysis failed:",a)}}async performDeepAnalysis(e){const r=`Analyze this resume and extract structured information. Return a valid JSON object with the following structure:

{
  "parsed_data": {
    "name": "string or null",
    "email": "string or null",
    "phone": "string or null",
    "location": "string or null",
    "summary": "string or null",
    "education": [{"degree": "string", "institution": "string", "year": "string", "gpa": "string", "location": "string"}],
    "work_experience": [{"title": "string", "company": "string", "duration": "string", "location": "string", "responsibilities": ["string"], "technologies": ["string"]}],
    "projects": [{"name": "string", "description": "string", "technologies": ["string"], "url": "string", "highlights": ["string"]}],
    "skills": [{"category": "string", "skills": ["string"]}],
    "certifications": ["string"],
    "achievements": ["string"]
  },
  "skills_detected": ["string"],
  "experience_level": "entry|junior|mid|senior|lead|executive",
  "years_of_experience": number,
  "domains": ["string"],
  "analysis_metadata": {
    "total_skills_count": number,
    "technical_skills_count": number,
    "soft_skills_count": number,
    "projects_count": number,
    "work_experiences_count": number,
    "education_count": number,
    "confidence_score": number (0-1),
    "analysis_version": "1.0",
    "analyzed_at": "ISO timestamp"
  }
}

Resume Text:
${e}

IMPORTANT: Return ONLY the JSON object, no additional text or explanation.`;try{const a=(await S.generateText(r)).replace(/```json\n?/g,"").replace(/```\n?/g,"").trim(),s=JSON.parse(a);return{parsed_data:s.parsed_data||this.getDefaultParsedData(),skills_detected:s.skills_detected||[],experience_level:s.experience_level||"junior",years_of_experience:s.years_of_experience||0,domains:s.domains||[],analysis_metadata:s.analysis_metadata||this.getDefaultMetadata()}}catch(t){return console.error("AI analysis failed, using fallback:",t),this.getFallbackAnalysis(e)}}getDefaultParsedData(){return{education:[],work_experience:[],projects:[],skills:[],certifications:[],achievements:[]}}getDefaultMetadata(){return{total_skills_count:0,technical_skills_count:0,soft_skills_count:0,projects_count:0,work_experiences_count:0,education_count:0,confidence_score:0,analysis_version:"1.0",analyzed_at:new Date().toISOString()}}getFallbackAnalysis(e){const t=["JavaScript","Python","React","Node.js","TypeScript","Java","SQL","MongoDB","AWS","Docker","Kubernetes","Git"].filter(c=>e.toLowerCase().includes(c.toLowerCase())),a=e.match(/(\d+)\+?\s*years?/i),s=a?parseInt(a[1]):1;let n="junior";return s>=7?n="senior":s>=4?n="mid":s>=2?n="junior":n="entry",{parsed_data:this.getDefaultParsedData(),skills_detected:t,experience_level:n,years_of_experience:s,domains:this.detectDomains(e),analysis_metadata:{...this.getDefaultMetadata(),total_skills_count:t.length,technical_skills_count:t.length,confidence_score:.5}}}detectDomains(e){return["Frontend Development","Backend Development","Full Stack Development","Mobile Development","Data Science","Machine Learning","DevOps","Cloud Engineering"].filter(t=>e.toLowerCase().includes(t.toLowerCase()))}async getUserResumes(e){const{data:r,error:t}=await i.from("user_resumes").select("*").eq("user_id",e).order("created_at",{ascending:!1});if(t)throw new Error(`Failed to fetch resumes: ${t.message}`);return r||[]}async getPrimaryResume(e){const{data:r,error:t}=await i.from("user_resumes").select("*").eq("user_id",e).eq("is_primary",!0).maybeSingle();if(t)throw new Error(`Failed to fetch primary resume: ${t.message}`);return r}async getResumeById(e){const{data:r,error:t}=await i.from("user_resumes").select("*").eq("id",e).maybeSingle();if(t)throw new Error(`Failed to fetch resume: ${t.message}`);return r}async setPrimaryResume(e,r){const{error:t}=await i.from("user_resumes").update({is_primary:!0}).eq("id",e).eq("user_id",r);if(t)throw new Error(`Failed to set primary resume: ${t.message}`)}async deleteResume(e,r){const t=await this.getResumeById(e);if(!t||t.user_id!==r)throw new Error("Resume not found or unauthorized");const a=t.file_url.split("/user-resumes/")[1];a&&await i.storage.from("user-resumes").remove([a]);const{error:s}=await i.from("user_resumes").delete().eq("id",e).eq("user_id",r);if(s)throw new Error(`Failed to delete resume: ${s.message}`)}async waitForAnalysis(e,r=30){const t=Date.now();for(;Date.now()-t<r*1e3;){const s=await this.getResumeById(e);if(s!=null&&s.analysis_completed)return s;await new Promise(n=>setTimeout(n,1e3))}const a=await this.getResumeById(e);if(!a)throw new Error("Resume not found");return a}}const T=new F;export{T as a,h as r};
