import{s as a}from"./index-BbSeE-q4.js";const v={"10:00-11:00":"10:00 AM - 11:00 AM","11:00-12:00":"11:00 AM - 12:00 PM","12:00-13:00":"12:00 PM - 1:00 PM","14:00-15:00":"2:00 PM - 3:00 PM","15:00-16:00":"3:00 PM - 4:00 PM"};class T{async getActiveService(){const{data:e,error:t}=await a.from("session_services").select("*").eq("is_active",!0).limit(1).maybeSingle();return t?(console.error("SessionBookingService: Error fetching service:",t.message),null):e}async getAvailableDates(e,t,s){const r=new Date(t,s,1),o=new Date(t,s+1,0),c=r.toISOString().split("T")[0],d=o.toISOString().split("T")[0],{data:n}=await a.from("session_services").select("max_slots_per_day, time_slots").eq("id",e).maybeSingle();if(!n)return[];const l=n.time_slots.length,_=n.max_slots_per_day,{data:E,error:S}=await a.from("session_slots").select("slot_date, status").eq("service_id",e).gte("slot_date",c).lte("slot_date",d);if(S)return console.error("SessionBookingService: Error fetching slots:",S.message),[];const u={},m={};(E||[]).forEach(i=>{i.status==="booked"?u[i.slot_date]=(u[i.slot_date]||0)+1:i.status==="blocked"&&(m[i.slot_date]=(m[i.slot_date]||0)+1)});const f=[],p=new Date;p.setHours(0,0,0,0);for(let i=new Date(r);i<=o;i.setDate(i.getDate()+1)){if(i<p)continue;const g=i.toISOString().split("T")[0],b=u[g]||0,B=m[g]||0,D=b+B,k=Math.min(l,_),y=Math.max(0,k-D);f.push({date:g,total_slots:k,booked_slots:b,available_slots:y,is_fully_booked:y===0})}return f}async getSlotsForDate(e,t){const{data:s}=await a.from("session_services").select("time_slots").eq("id",e).maybeSingle();if(!s)return[];const r=s.time_slots,{data:o,error:c}=await a.from("session_slots").select("*").eq("service_id",e).eq("slot_date",t);if(c)return console.error("SessionBookingService: Error fetching day slots:",c.message),[];const d={};return(o||[]).forEach(n=>{d[n.time_slot]=n}),r.map(n=>{const l=d[n];return{time_slot:n,label:v[n]||n,status:(l==null?void 0:l.status)||"available",slot_id:l==null?void 0:l.id}})}async bookSlot(e,t,s,r,o,c,d,n){const{data:l,error:_}=await a.rpc("book_slot_atomically",{p_user_id:e,p_service_id:t,p_slot_date:s,p_time_slot:r,p_payment_transaction_id:o,p_user_name:c,p_user_email:d,p_user_phone:n||null});return _?(console.error("SessionBookingService: Booking RPC error:",_.message),{success:!1,error:"Failed to book slot. Please try again."}):l}async getUserBookings(e){const{data:t,error:s}=await a.from("session_bookings").select("*, session_services(*)").eq("user_id",e).order("booking_date",{ascending:!1});return s?(console.error("SessionBookingService: Error fetching bookings:",s.message),[]):t||[]}async getBookingById(e){const{data:t,error:s}=await a.from("session_bookings").select("*, session_services(*)").eq("id",e).maybeSingle();return s?(console.error("SessionBookingService: Error fetching booking:",s.message),null):t}async cancelBooking(e,t){const{data:s,error:r}=await a.from("session_bookings").select("slot_id, status").eq("id",e).maybeSingle();if(r||!s)return{success:!1,error:"Booking not found."};if(s.status!=="confirmed")return{success:!1,error:"Only confirmed bookings can be cancelled."};const{error:o}=await a.from("session_bookings").update({status:"cancelled",cancellation_reason:t||"Cancelled by user",updated_at:new Date().toISOString()}).eq("id",e);return o?{success:!1,error:"Failed to cancel booking."}:(s.slot_id&&await a.from("session_slots").update({status:"available",booked_by:null,booking_id:null,updated_at:new Date().toISOString()}).eq("id",s.slot_id),{success:!0})}async createPaymentTransaction(e,t,s){const{data:r,error:o}=await a.from("payment_transactions").insert({user_id:e,status:"pending",amount:s,currency:"INR",final_amount:s,purchase_type:"session_booking",plan_id:null,metadata:{service_id:t}}).select("id").single();return o?(console.error("SessionBookingService: Error creating payment:",o.message),null):r.id}async updatePaymentTransaction(e,t,s,r){const{error:o}=await a.from("payment_transactions").update({payment_id:t,order_id:s,status:r}).eq("id",e);return o?(console.error("SessionBookingService: Error updating payment:",o.message),!1):!0}getSlotLabel(e){return v[e]||e}generateCalendarUrl(e){const t=e.booking_date.replace(/-/g,""),[s]=e.time_slot.split("-"),[r]=e.time_slot.split("-").slice(1),o=s.replace(":",""),c=r.replace(":",""),d=encodeURIComponent("PrimoBoost Resume Session"),n=encodeURIComponent(`Booking ID: ${e.booking_code}
Resume Session - Career Transformation`);return`https://calendar.google.com/calendar/render?action=TEMPLATE&text=${d}&dates=${t}T${o}00/${t}T${c}00&details=${n}`}generateICSContent(e){const t=e.booking_date.replace(/-/g,""),[s]=e.time_slot.split("-"),[r]=e.time_slot.split("-").slice(1),o=s.replace(":",""),c=r.replace(":","");return["BEGIN:VCALENDAR","VERSION:2.0","PRODID:-//PrimoBoost//Session//EN","BEGIN:VEVENT",`DTSTART:${t}T${o}00`,`DTEND:${t}T${c}00`,"SUMMARY:PrimoBoost Resume Session",`DESCRIPTION:Booking ID: ${e.booking_code}\\nResume Session - Career Transformation`,"END:VEVENT","END:VCALENDAR"].join(`\r
`)}}const M=new T;export{M as s};
